# Метрики производительности BlobStorage

BlobStorage имеет определенную пропускную способность, ограниченную ресурсами физических устройств в кластере и может обеспечивать низкое время отклика, если нагрузка не превышает эту пропускную способность. Метрики производительности отображают количество доступных ресурсов физических устройств и позволяют оценить уровень их потребления. По значениям метрик производительности можно отслеживать, выполнены ли необходимые условия гарантий низкого времени отклика BlobStorage, а именно, что средний поток нагрузки не превышает предельно допустимый, и что отсутствуют краткосрочные всплески нагрузки.

### Модель стоимость запроса

Стоимость запроса - это оценка времени в условных единицах, которое затратит физическое устройство на выполенение этой операции. Стоимость запроса вычисляется по простой модели физического устройства. Мы предполагаем, что физическое устройство может одновременно выполнять только один запрос чтения или записи. На выполнение операции уходит определенное время работы устройства, соотвественно суммарное время выполнения запросов за определенный промежуток времени не может быть больше величины этого промежутка. 

Стоимость запроса вычисляется по линейной формуле:

$$
cost(operation) = A + operation.size() \times B
$$

Физический смысл линейной зависимости таков: коэффициент $A$ - это время, необходимое физическому устройству для получения доступа к данным, коэффициент $B$ - это время, необходимое для чтения или записи одного байта данных.

Коэффициенты $A$ и $В$ зависят от типа запроса и типа устройства и были измерены экспериментально для каждого типа устройства и каждого типа запроса.

В ситеме YDB все физические устройства делятся на три типа: HDD, SATA SSD (далее SSD) и NVME SSD (далее NVME). HDD - это крутящиеся жесткие диски, они отличаются высоким временем доступа к данным. Типы SSD и NVME отличаются интерфейсом: NVME обеспечивает более высокую скорость выполнения операций.

Операции делятся на 3 типа: чтение, запись и huge-запись. Разделение записи на обычную и huge-запись обусловлено спецификой записи данных VDisk'ом.

Помимо пользовательских запросов, нагрузку на BlobStorage создают фоновые процессы компакшена, скраббинга и дефрагментации, а также внутренняя коммуникация между VDisk'ами. Процесс компакшена может создавать особенно высокую нагрузку при достаточно большом потоке записей маленьких блобов.

### Доступное время диска

Планировщик PDisk управляет порядком выполнения PDisk'ом запросов от его клиентов-VDisk'ов. PDisk честно делит время устройства между своими VDisk'ами, то есть каждому из $n$ VDisk'ов гарантируется $1/n$ секунд работы физического устройства каждую секунду. На основе информации о количестве VDisk'ов-соседей для каждого VDisk'а рассчитывается доступное время диска или `DiskTimeAvailable`.

### Детектор всплеск нагрузки

Всплеск - это резкое краткосрочное повышение нагрузки на VDisk, которое может приводить к деградации времени отклика операций. Значения сенсоров с нод кластера собираются через определенные промежутки времени, например, раз в 15 секунд, что делает невозможным надежное обнаружение краткосрочных событий с помощью одних только метрик стоимости запросов и доступного времени диска. Для решения этой задачи используется модифицированный [алгоритм Token Bucket](https://en.wikipedia.org/wiki/Token_bucket), в нашей модификации в ведре может быть отрицательное количество токенов, и такое состояние мы будем называть underflow. К каждому VDisk'у привязан отдельный объект Token Bucket. Минимальное ожидаемое время отклика, при котором повышение нагрузки считается всплеском, определяется параметром `BurstThresholdNs`. Ведро будет переполняться, если расчетная длительность обработки всплеска запросов в наносекундах превысит значение `BurstThresholdNs`.

#### Значения `BurstThresholdNs` по умолчанию

Тип устройства | Значение `BurstThresholdNs` по умолчанию | В миллисекундах
--- | --- | ---
`ROT` | 200000000 | 200
`SSD` | 50000000 | 50
`NVME` | 32000000 | 32


### Метрики производительности

Метрики производительности вычисляются через следующие сенсоры VDisk'а:
- `DiskTimeAvailable` - доступное время диска.
- `UserDiskCost` - суммарная стоимость запросов, полученных VDisk'ом из BlobStorage Proxy.
- `InternalDiskCost` - суммарная стоимость запросов, полученных VDisk'ом от другого VDisk'а группы. Такие запросы включают в себя, например, запросы процесса репликации.
- `CompactionDiskCost` - суммарная стоимость запросов, отправленных VDisk'ом в рамках системного процесса компакшена.
- `DefragDiskCost` - суммарная стоимость запросов, отправленных VDisk'ом в рамках системного процесса дефрагментации.
- `ScrubDiskCost` - суммарная стоимость запросов, отправленных VDisk'ом в рамках системного процесса скраббинга.
- `BurstDetector_redMs` - время в миллисекундах, на протяжении которого Token Bucket находился в состоянии underflow.

### Условия гарантий распределенного хранилища {#requirements}

Распределенное хранилище YDB может обеспечивать низкое время отклика только при соблюдении следующих условий:
1. `DiskTimeAvailable >= UserDiskCost + InternalDiskCost + CompactionDiskCost + DefragDiskCost + ScrubDiskCost` - средний поток нагрузки не превышает предельно допустимый.
2. `BurstDetector_redMs = 0` - отсутствуют краткосрочные пики нагрузки, приводящие к образованию очередей запросов.

### Настройка метрик

Поскольку коэффициенты для формулы стоимости запроса измерялись на конкретных физических устройствах с разработческих кластеров, а производительность других устройств может отличаться, метрики могут потребовать масштабирования для использования их в качестве источника гарантий BlobStorage. Для этого задайте параметру `DiskTimeAvailableScale` в [конфигурации BlobStorage](../../deploy/configuration/config.md#blob-storage-config) значение, равное отношению производительности устройств кластера и эталона. Например, если ваша система использует NVME устройства и обеспечивает на 10% более высокую производительность, чем эталон, то задайте следующую конфигурацию:
```
blob_storage_config:
  vdisk_types:
  - pdisk_type: NVME
    disk_time_available_scale: 1.1
```

Параметр `BurstThresholdNs` также настраивается отдельно для каждого типа устройств. Например, если вы используете HDD-устройства и в условиях вашей нагрузки максимально допустимое время отклика составляет 500 мс, то задайте следующую конфигурацию:
```
blob_storage_config:
  vdisk_types:
  - pdisk_type: ROT
    burst_threshold_ns: 500000000
```

### Как сравнить свое устройство с эталоном

Чтобы сравнить производительность BlobStorage на вашей системе с эталонной, необходимо загрузить распределенное хранилище запросами до такого состояния, когда VDisk'и не могут обрабатывать поток входящих запросов. В этот момент запросы начинают выстраиваться в очередь, и время отклика VDisk'ов резко возрастает. Посчитайте величину $D$ в момент, предшествующий перегрузке:
$$
D = \frac{UserDiskCost + InternalDiskCost + CompactionDiskCost + DefragDiskCost + ScrubDiskCost}{DiskTimeAvailable}
$$
Задайте параметр `disk_time_available_scale` конфигурации равным рассчитанному значению $D$. Мы предполагаем, что физические устройства на пользовательском кластере по производительности сравнимы с эталоном, поэтому по умолчанию параметр `disk_time_available_scale` равен 1.

Создать подобную нагрузку можно, например, с помощью [Storage LoadActor](../../development/load-actors-storage.md).

### Дашборд в Monitoring
Для удобного просмотра метрик и диагностики существует [дашборд](https://m.yandex-team.ru/projects/kikimr/dashboards/mongi8n4phijn4n3o4il) во внутреннем инструменте Monitoring.

Основной интерес представляют следующие графики:
- `Storage group latency` - время отклика запросов в BlobStorage.
- `Cost and DiskTimeAvailable relation` - отображает соотношение суммарной оценки стоимости запросов и доступного времени диска. По этому графику можно следить, выполнено ли условие (1) [гарантий распределенного хранилища](#requirements), то есть, что сумма `UserDiskCost + InternalDiskCost + CompactionDiskCost + DefragDiskCost + ScrubDiskCost` не превышает `DiskTimeAvailable`
- `Burst duration, ms` - время в миллисекундах, на протяжении которого наблюдались всплески нагрузки. По этому графику можно следить, выполнено ли условие (2) [гарантий распределенного хранилища](#requirements), то есть, что значение `BurstDetector_redMs` равно 0
